<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Centre for Research into Ecological and Environmental Modelling   University of St Andrews">

<title>Introductory distance sampling training materials - Analysis of animals that occur in groups solution</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://kit.fontawesome.com/78ddb093ea.js" crossorigin="anonymous"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Introductory distance sampling training materials</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://distancesampling.org" rel="" target="">
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Analysis of animals that occur in groups <strong>solution</strong></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../01-intro/introlanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fundamentals of distance sampling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../01-intro/Mod1-2023-intro.pdf" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture slides</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://youtu.be/_4RX6P4PB4k" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture video</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../01-intro/introlanding.html#exercise-materials" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercise materials</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Detection function modelling</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../02-detfns/detfnlanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fitting detection functions to line transect data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Model criticism</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../03-criticism/criticismlanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model criticism</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Precision of density estimates</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../04-precision/precisionlanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Precision of density estimates</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Point transect analysis</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../05-points/pointslanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis of point transect data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">Design of distance sampling surveys</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../06-design/designlanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Design of distance sampling surveys</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">Analysis of stratified designs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../07-stratify/stratifylanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis of stratified surveys</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false">
 <span class="menu-text">Covariates in the detection functions</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../08-covariates/covariateslanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Including covariates in detection function modelling</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="false">
 <span class="menu-text">Animals detected in clusters</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../09-clusters/clusterslanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis of animals in groups</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="false">
 <span class="menu-text">Multipliers</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../10-multipliers/multiplierslanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multipliers and indirect surveys</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="false">
 <span class="menu-text">Double platform data (the g(0) problem)</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../11-mrds/mrdslanding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis of double platform data</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#analysis-of-rissos-dolphin-survey-data" id="toc-analysis-of-rissos-dolphin-survey-data" class="nav-link active" data-scroll-target="#analysis-of-rissos-dolphin-survey-data">Analysis of Risso’s dolphin survey data</a>
  <ul class="collapse">
  <li><a href="#naive-analysis" id="toc-naive-analysis" class="nav-link" data-scroll-target="#naive-analysis">Naive analysis</a></li>
  <li><a href="#analysis-adjusting-for-size-bias-problem" id="toc-analysis-adjusting-for-size-bias-problem" class="nav-link" data-scroll-target="#analysis-adjusting-for-size-bias-problem">Analysis adjusting for size bias problem</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analysis of animals that occur in groups <strong>solution</strong></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Centre for Research into Ecological and Environmental Modelling <br> <strong>University of St Andrews</strong> </p>
          </div>
  </div>
    
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">January 2024</p>
    </div>
  </div>
    
  </div>
  

</header>

<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Analysis of animals that occur in groups</p>
</div>
</div>
<section id="analysis-of-rissos-dolphin-survey-data" class="level1">
<h1>Analysis of Risso’s dolphin survey data</h1>
<section id="naive-analysis" class="level2">
<h2 class="anchored" data-anchor-id="naive-analysis">Naive analysis</h2>
<p>If we apply distance sampling to the perpendicular distances recorded to the centre of the detected groups, we will estimate the abundance of groups (<span class="math inline">\(\widehat{N_s}\)</span>), corrected for imperfect detectability. To convert abundance of groups (<span class="math inline">\(\widehat{N_s}\)</span>) to abundance of individuals (<span class="math inline">\(\widehat{N}\)</span>), we multiply:</p>
<p><span class="math display">\[\widehat{N_s} \times \bar{s} = \widehat{N}\]</span> where {s} is the average size of groups in the population <span class="citation" data-cites="Buckland2015">(<a href="#ref-Buckland2015" role="doc-biblioref">Buckland et al., 2015, sec. 6.3.1.3</a>)</span>. We do not know the average size of groups in the population, but rather we estimate it by using the average size of our detected groups.</p>
<p>Because there exists a field named <code>size</code> in the <code>risso</code> data frame, the <code>ds</code> software knows observations were of groups. Output from <code>ds</code> will create estimates both of <span class="math inline">\(\widehat{N_s}\)</span> and <span class="math inline">\(\widehat{N}\)</span> (if study region <code>Area</code> is also provided), and companion estimates <span class="math inline">\(\widehat{D_s}\)</span> and <span class="math inline">\(\widehat{D}\)</span>.</p>
<p>Fit the three key function detection models to the data in the usual manner and perform model selection to choose a most appropriate model (also perform absolute goodness of fit, courtesy of <code>summarize_ds_models</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>rissogithub <span class="ot">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/distanceworkshops/async2024-2/main/09-clusters/R-prac/Risso_survey.csv"</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>risso <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(rissogithub)</span>
<span id="cb1-3"><a href="#cb1-3"></a>aveobs.size <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">mean</span>(risso<span class="sc">$</span>size),<span class="dv">2</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(Distance)</span>
<span id="cb1-5"><a href="#cb1-5"></a>naive.uniform <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>risso, <span class="at">key=</span><span class="st">"unif"</span>, <span class="at">adjustment=</span><span class="st">"cos"</span>)</span>
<span id="cb1-6"><a href="#cb1-6"></a>naive.hn <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>risso, <span class="at">key=</span><span class="st">"hn"</span>, <span class="at">adjustment =</span> <span class="st">"cos"</span>) </span>
<span id="cb1-7"><a href="#cb1-7"></a>naive.hr <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>risso, <span class="at">key=</span><span class="st">"hr"</span>, <span class="at">adjustment =</span> <span class="cn">NULL</span>) <span class="co"># no adjustments for simplicity</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">summarize_ds_models</span>(naive.uniform, naive.hn, naive.hr, <span class="at">output=</span><span class="st">"plain"</span>),</span>
<span id="cb1-9"><a href="#cb1-9"></a>             <span class="at">digits=</span><span class="dv">3</span>, <span class="at">caption=</span><span class="st">"Model selection for models not considering size bias."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Model selection for models not considering size bias.</caption>
<colgroup>
<col style="width: 2%">
<col style="width: 9%">
<col style="width: 34%">
<col style="width: 5%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 17%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">Model</th>
<th style="text-align: left;">Key function</th>
<th style="text-align: left;">Formula</th>
<th style="text-align: right;">C-vM <span class="math inline">\(p\)</span>-value</th>
<th style="text-align: right;">Average detectability</th>
<th style="text-align: right;">se(Average detectability)</th>
<th style="text-align: right;">Delta AIC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2</td>
<td style="text-align: left;">naive.hn</td>
<td style="text-align: left;">Half-normal with cosine adjustment term of order 2</td>
<td style="text-align: left;">~1</td>
<td style="text-align: right;">0.981</td>
<td style="text-align: right;">0.548</td>
<td style="text-align: right;">0.047</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">3</td>
<td style="text-align: left;">naive.hr</td>
<td style="text-align: left;">Hazard-rate</td>
<td style="text-align: left;">~1</td>
<td style="text-align: right;">0.981</td>
<td style="text-align: right;">0.531</td>
<td style="text-align: right;">0.070</td>
<td style="text-align: right;">1.264</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">naive.uniform</td>
<td style="text-align: left;">Uniform with cosine adjustment terms of order 1,2</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0.902</td>
<td style="text-align: right;">0.581</td>
<td style="text-align: right;">0.044</td>
<td style="text-align: right;">2.497</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>All three models fit. It is a close AIC contest between the unadjusted hazard rate and the half normal with one adjustment. For our purposes, let’s focus upon the hazard rate model, although the inference will be virtually identical were we to use the half normal model for our inference.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">plot</span>(naive.hr, <span class="at">nc=</span><span class="dv">40</span>, <span class="at">main=</span><span class="st">"Hazard rate model with no adjustments"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Prac9_solution_files/figure-html/naivehrplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A brief look at the data summary coming from the fitted model. Evaluate the number of detections and numbers of replicate transects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(naive.hr<span class="sc">$</span>dht<span class="sc">$</span>clusters<span class="sc">$</span>summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 9%">
<col style="width: 11%">
<col style="width: 16%">
<col style="width: 9%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Region</th>
<th style="text-align: right;">Area</th>
<th style="text-align: right;">CoveredArea</th>
<th style="text-align: right;">Effort</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">k</th>
<th style="text-align: right;">ER</th>
<th style="text-align: right;">se.ER</th>
<th style="text-align: right;">cv.ER</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">region</td>
<td style="text-align: right;">1300000</td>
<td style="text-align: right;">143145.6</td>
<td style="text-align: right;">15600</td>
<td style="text-align: right;">265</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0.0169872</td>
<td style="text-align: right;">0.0008546</td>
<td style="text-align: right;">0.0503073</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Examine the estimates of abundance of clusters (<span class="math inline">\(\widehat{N_s}\)</span>) from the hazard rate model. Note how the following code carefully extracts estimates only for clusters. We could do the same for the estimated density of clusters, but omit that here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(naive.hr<span class="sc">$</span>dht<span class="sc">$</span>clusters<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Label</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">se</th>
<th style="text-align: right;">cv</th>
<th style="text-align: right;">lcl</th>
<th style="text-align: right;">ucl</th>
<th style="text-align: right;">df</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Total</td>
<td style="text-align: right;">4531.354</td>
<td style="text-align: right;">642.8413</td>
<td style="text-align: right;">0.1418652</td>
<td style="text-align: right;">3431.138</td>
<td style="text-align: right;">5984.361</td>
<td style="text-align: right;">230.2186</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Compare this estimate against the number of clusters (4333) in the population we simulated.</p>
<p>How well did this model estimate the number of individuals (<span class="math inline">\(\widehat{N}\)</span>) in the population?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(naive.hr<span class="sc">$</span>dht<span class="sc">$</span>individuals<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Label</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">se</th>
<th style="text-align: right;">cv</th>
<th style="text-align: right;">lcl</th>
<th style="text-align: right;">ucl</th>
<th style="text-align: right;">df</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Total</td>
<td style="text-align: right;">32677.05</td>
<td style="text-align: right;">4770.298</td>
<td style="text-align: right;">0.1459831</td>
<td style="text-align: right;">24537.47</td>
<td style="text-align: right;">43516.69</td>
<td style="text-align: right;">186.701</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Compare this estimate against the number of individuals in the population (26000). The reason for this lies in the estimation of average group size in the population, also estimated in the model object by the average size of detected groups:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(naive.hr<span class="sc">$</span>dht<span class="sc">$</span>Expected.S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Region</th>
<th style="text-align: right;">Expected.S</th>
<th style="text-align: right;">se.Expected.S</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Total</td>
<td style="text-align: right;">7.211321</td>
<td style="text-align: right;">0.138989</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Compare this estimate against the estimate we produced during our exploratory data analysis plotting the histogram of sizes of observed groups: 7.21.</p>
</section>
<section id="analysis-adjusting-for-size-bias-problem" class="level2">
<h2 class="anchored" data-anchor-id="analysis-adjusting-for-size-bias-problem">Analysis adjusting for size bias problem</h2>
<p>Because we recognize that the size of clusters influences probability of their inclusion in our sample, we can incorporate this concept in the detection function model we construct. As introduced in <a href="../../08-covariates/covariateslanding.html">Module 8</a>, we can add covariates in addition to perpendicular distance into our detection function models. This is what we will do to perhaps overcome the size bias problem.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Aside: average group size as derived parameter
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<ul>
<li>When using group size as a covariate we no longer estimate average group size directly from observed group sizes. Instead, the <code>ds</code> function uses something called Horwitz-Thompson-like estimators to first estimate the abundance of groups. Then, using the same estimation approach, <code>ds</code> estimates the abundance of individuals.</li>
<li>After the two estimates <span class="math inline">\(\widehat{N_s}\)</span> and <span class="math inline">\(\widehat{N}\)</span> are produced, their ratio is computed. This ratio is a less biased estimate of average group size in the population.</li>
<li>See the next-to-last slide in <a href="../../08-covariates/Mod8-2023-covariates.pdf">Module 8 lecture</a></li>
</ul>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>clever.hn <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>risso, <span class="at">key=</span><span class="st">"hn"</span>, <span class="at">formula =</span> <span class="sc">~</span>size) </span>
<span id="cb7-2"><a href="#cb7-2"></a>clever.hr <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>risso, <span class="at">key=</span><span class="st">"hr"</span>, <span class="at">formula =</span> <span class="sc">~</span>size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Contrast AIC scores between hazard rate and half normal models with and without the <code>size</code> covariate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">AIC</span>(naive.hn, naive.hr, clever.hn, clever.hr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          df      AIC
naive.hn   2 759.8031
naive.hr   2 761.0671
clever.hn  2 740.7369
clever.hr  3 737.3162</code></pre>
</div>
</div>
<p>Compare relative and absolute fit of hazard rate and half normal key functions that include the <code>size</code> covariate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">summarize_ds_models</span>(clever.hn, clever.hr, <span class="at">output=</span><span class="st">"plain"</span>), <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb10-2"><a href="#cb10-2"></a>             <span class="at">caption =</span> <span class="st">"Comparison of hazard rate and half normal models incorporating group size as covariate."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Comparison of hazard rate and half normal models incorporating group size as covariate.</caption>
<colgroup>
<col style="width: 2%">
<col style="width: 9%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 14%">
<col style="width: 20%">
<col style="width: 24%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">Model</th>
<th style="text-align: left;">Key function</th>
<th style="text-align: left;">Formula</th>
<th style="text-align: right;">C-vM <span class="math inline">\(p\)</span>-value</th>
<th style="text-align: right;">Average detectability</th>
<th style="text-align: right;">se(Average detectability)</th>
<th style="text-align: right;">Delta AIC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2</td>
<td style="text-align: left;">clever.hr</td>
<td style="text-align: left;">Hazard-rate</td>
<td style="text-align: left;">~size</td>
<td style="text-align: right;">0.880</td>
<td style="text-align: right;">0.503</td>
<td style="text-align: right;">0.067</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: left;">clever.hn</td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~size</td>
<td style="text-align: right;">0.423</td>
<td style="text-align: right;">0.614</td>
<td style="text-align: right;">0.032</td>
<td style="text-align: right;">3.421</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Using the best model based upon AIC, repeat the model output interrogation you conducted (above) with the naive models: examine the estimates of <span class="math inline">\(\widehat{N_s}\)</span>, <span class="math inline">\(\widehat{N}\)</span> and <span class="math inline">\(E(s)\)</span> (defined as the expected value of group size in the population):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(clever.hr<span class="sc">$</span>dht<span class="sc">$</span>clusters<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Label</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">se</th>
<th style="text-align: right;">cv</th>
<th style="text-align: right;">lcl</th>
<th style="text-align: right;">ucl</th>
<th style="text-align: right;">df</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Total</td>
<td style="text-align: right;">4779.932</td>
<td style="text-align: right;">659.8679</td>
<td style="text-align: right;">0.1380496</td>
<td style="text-align: right;">3645.556</td>
<td style="text-align: right;">6267.288</td>
<td style="text-align: right;">202.2487</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Compare this estimate against the number of clusters (4333) in the population we simulated.</p>
<p>How well did this model estimate the number of individuals (<span class="math inline">\(\widehat{N}\)</span>) in the population?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(clever.hr<span class="sc">$</span>dht<span class="sc">$</span>individuals<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Label</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">se</th>
<th style="text-align: right;">cv</th>
<th style="text-align: right;">lcl</th>
<th style="text-align: right;">ucl</th>
<th style="text-align: right;">df</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Total</td>
<td style="text-align: right;">27449.21</td>
<td style="text-align: right;">2743.127</td>
<td style="text-align: right;">0.0999347</td>
<td style="text-align: right;">22541.21</td>
<td style="text-align: right;">33425.84</td>
<td style="text-align: right;">148.0588</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Compare this estimate against the number of individuals in the population (26000). The reason for this lies in the estimation of average group size in the population, also estimated in the model object by the average size of detected groups:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(clever.hr<span class="sc">$</span>dht<span class="sc">$</span>Expected.S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Region</th>
<th style="text-align: right;">Expected.S</th>
<th style="text-align: right;">se.Expected.S</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Total</td>
<td style="text-align: right;">5.742594</td>
<td style="text-align: right;">0.4046648</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Conclusion
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<ul>
<li>Estimation of number of clusters (<span class="math inline">\(\widehat{N_s}\)</span>) is close to the truth when not including cluster size as a covariate.</li>
<li>However, average size of clusters in the sample is an over-estimate of the average size of groups in the population.
<ul>
<li>This is because small groups at great distances are not detected, hence not included in the sample.</li>
</ul></li>
<li>Because of this bias in estimate average cluster size, the estimate of number of individuals in the population (<span class="math inline">\(\widehat{N}\)</span>) is positively biased.</li>
<li>This size bias can be reduced by incorporating cluster size as a covariate in the detection function.
<ul>
<li>When this was done, the estimated number of individuals in the population (<span class="math inline">\(\widehat{N}\)</span>) was closer to the true population size.</li>
</ul></li>
<li>In general, the effect of size bias is magnified as the variability of cluster sizes in the population increases.</li>
<li>There is another way of dealing with size bias, regressing ln(cluster size) against estimated detection probability for the detection distance <span class="math inline">\(\widehat{g(x)}\)</span>. This method is <a href="../../09-clusters/DistWin-prac/Pr9-instructions-DistWin.html">implemented in the Distance for Windows software</a>.</li>
</ul>
</div>
</div>
</div>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2" role="list">
<div id="ref-Buckland2015" class="csl-entry" role="listitem">
Buckland, S. T., Rexstad, E. A., Marques, T. A., &amp; Oedekoven, C. S. (2015). <em>Distance sampling: Methods and applications</em>. <span>Springer</span>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Centre for Research into Ecological and Environmental Modelling</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">University of St Andrews</div>
  </div>
</footer>



</body></html>